## 发布后端任务

#### 自动构建common jar包
* 创建任务
  <br>![创建任务](http://xuye-private.oss-cn-shanghai.aliyuncs.com/mackdown/Jenkins/20.png)
* 选择构建Maven
  <br>![选择构建maven](http://xuye-private.oss-cn-shanghai.aliyuncs.com/mackdown/Jenkins/21.png)
* 丢弃旧的构建
  <br>![丢弃旧的构建](http://xuye-private.oss-cn-shanghai.aliyuncs.com/mackdown/Jenkins/32.png)
* 源码管理
  <br>![源码管理](http://xuye-private.oss-cn-shanghai.aliyuncs.com/mackdown/Jenkins/22.png)  
* 构建触发器
  <br>![构建触发器](http://xuye-private.oss-cn-shanghai.aliyuncs.com/mackdown/Jenkins/23.png)  
  <br>![触发的分支](http://xuye-private.oss-cn-shanghai.aliyuncs.com/mackdown/Jenkins/36.png)
* Build
  <br>![Build](http://xuye-private.oss-cn-shanghai.aliyuncs.com/mackdown/Jenkins/24.png)  
* 保存任务
* GitLab配置Webhook(记得去掉ssl证书验证)
  <br>![gitlab配置webhook](http://xuye-private.oss-cn-shanghai.aliyuncs.com/mackdown/Jenkins/25.png)
  <br>![gitlab配置webhook](http://xuye-private.oss-cn-shanghai.aliyuncs.com/mackdown/Jenkins/29.png)    
* GitLab测试自动构建
  <br>![gitlab测试自动构建](http://xuye-private.oss-cn-shanghai.aliyuncs.com/mackdown/Jenkins/26.png)  
  <br>![gitlab测试自动构建](http://xuye-private.oss-cn-shanghai.aliyuncs.com/mackdown/Jenkins/27.png)  
* Jenkins查看结果
  <br>![Jenkins查看结果](http://xuye-private.oss-cn-shanghai.aliyuncs.com/mackdown/Jenkins/28.png)  

#### 自动构建子项目
* 自动构建子项目
  <br>![自动构建子项目](http://xuye-private.oss-cn-shanghai.aliyuncs.com/mackdown/Jenkins/30.png)  
* 构建前操作
  <br>![自动构建子项目](http://xuye-private.oss-cn-shanghai.aliyuncs.com/mackdown/Jenkins/35.png)
  * shell 脚本
    ```shell script
      DATE=$(date +%Y-%m-%d_%H:%M:%S)
      FILE_DIR=/data/server/$1
      BAK_DIR=$FILE_DIR/bak
      FILE_NAME=$1-$2-SNAPSHOT.jar
      BAK_FILE_NAME=$FILE_NAME.bak$DATE
      echo "备份文件开始..."
      if [ ! -d $BAK_DIR ];then
         mkdir -p $BAK_DIR
      fi
      mv $FILE_DIR/$FILE_NAME $BAK_DIR/$BAK_FILE_NAME
      echo "备份文件结束"
    ```
* Post Steps
  <br>![Post Steps](http://xuye-private.oss-cn-shanghai.aliyuncs.com/mackdown/Jenkins/33.png)  
* 构建后操作
  <br>![构建后操作](http://xuye-private.oss-cn-shanghai.aliyuncs.com/mackdown/Jenkins/34.png)
  * shell 脚本
  ```shell script
    FILE_DIR=/data/server/$1
    FILE_NAME=$1-$2-SNAPSHOT.jar
    pid=`ps -ef | grep "$1" | grep "java" | awk '{print $2}'`
    echo “旧进程id:$pid”
    if [ -n "$pid" ]
    then
    echo "杀死旧进程id:$pid"
    kill -9 $pid
    fi
    cd $FILE_DIR
    echo "启动进程，睡眠10s..."
    nohup java -jar $FILE_NAME >> nohup.out &
    sleep 10s
    npid=`ps -ef | grep $1 | grep -v grep | awk '{print $2}'`
    echo "打印最后50行日志"
    tail -n 50 nohup.out
    echo "打印完毕，新的进程id:$npid:$?"
  ```
  
