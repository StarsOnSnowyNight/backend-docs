## YApi内网部署

### 参考
1. **[GitHub](https://www.rabbitmq.com/which-erlang.html)** </br>
2. **[YApi安装](https://www.jianshu.com/p/5bda5556c149)**
3. **[nodejs安装](https://www.cnblogs.com/feiquan/p/11223487.html)**
4. **[mongodb安装](https://jingyan.baidu.com/article/e5c39bf5f5ddd539d76033a9.html)**

### 安装过程
1. **安装nodejs**
   * 添加源
   ```
   ubuntu@VM-0-9-ubuntu:~$ curl -sL https://deb.nodesource.com/setup_10.x | sudo -E bash -
   ...
   出现如下报错，先不管。
   ...
   ## Run `sudo apt-get install -y nodejs` to install Node.js 10.x and npm
   ## You may also need development tools to build native addons:
        sudo apt-get install gcc g++ make
   ## To install the Yarn package manager, run:
        curl -sL https://dl.yarnpkg.com/debian/pubkey.gpg | gpg --dearmor | sudo tee /usr/share/keyrings/yarnkey.gpg >/dev/null
        echo "deb [signed-by=/usr/share/keyrings/yarnkey.gpg] https://dl.yarnpkg.com/debian stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
        sudo apt-get update && sudo apt-get install yarn
   ```
   * 安装nodejs
   ```
   ubuntu@VM-0-9-ubuntu:~$ sudo apt-get install -y nodejs
   查询版本
   node -v
   如果没有安装成功，可以把上面的报错执行一次
   curl -sL https://dl.yarnpkg.com/debian/pubkey.gpg | gpg --dearmor | sudo tee /usr/share/keyrings/yarnkey.gpg >/dev/null
   echo "deb [signed-by=/usr/share/keyrings/yarnkey.gpg] https://dl.yarnpkg.com/debian stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
   sudo apt-get update && sudo apt-get install yarn
   再次查询版本
   ubuntu@VM-0-160-ubuntu:~$ node -v
   v10.24.1
   ```
2. **安装mongodb**
   * 安装mongodb
      ```
      ubuntu@VM-0-160-ubuntu:~$ sudo apt-get update
      ubuntu@VM-0-160-ubuntu:~$ sudo apt-get install mongodb
      ubuntu@VM-0-160-ubuntu:~$ mongo -version
      MongoDB shell version: 2.6.10
      ```
3. **安装YApi**
     * 安装YApi
        ```
        ubuntu@VM-0-160-ubuntu:~$ sudo npm install -g yapi-cli --registry https://registry.npm.taobao.org
        启动可视化安装
        ubuntu@VM-0-160-ubuntu:~$ sudo yapi server
        在浏览器打开 http://0.0.0.0:9090 访问。非本地服务器，请将 0.0.0.0 替换成指定的域名或ip 
        安全组开放相关端口。并访问对应地址
        ```
     * 可视化安装
     安装目录：/data/my-yapi
     ![版本选择](http://xuye-private.oss-cn-shanghai.aliyuncs.com/mackdown/YApi/3.png)
     ```
     部署完成后，在控制台看到如下信息
     初始化管理员账号成功,账号名："admin@admin.com"，密码："ymfe.org"
     部署成功，请切换到部署目录，输入： "node vendors/server/app.js" 指令启动服务器, 然后在浏览器打开 http://127.0.0.1:3000 访问
     ```
     * 启动服务
     ```
      ubuntu@VM-0-9-ubuntu:~$ cd /data/my-yapi
      ubuntu@VM-0-9-ubuntu:/data/my-yapi$ sudo nohup node vendors/server/app.js &
      关闭服务
      ps -ef|grep node
     ```
     * 服务管理
     ```
      具体不知道怎么用，以后再研究
      ubuntu@VM-0-9-ubuntu:/data/my-yapi$ sudo npm install pm2 -g
      ubuntu@VM-0-9-ubuntu:/data/my-yapi$ cd /data/my-yapi
      //pm2管理yapi服务
      ubuntu@VM-0-9-ubuntu:/data/my-yapi$ sudo pm2 start "vendors/server/app.js" --name yapi
      pm2 info yapi //查看服务信息
      pm2 stop yapi //停止服务
      pm2 restart yapi //重启服务
     ```
     * 关闭注册
     在 config.json 添加 closeRegister:true 配置项,就可以禁止用户注册 yapi 平台，修改完成后，请重启 yapi 服务器。
     ```
     {
       "port": "*****",
       "closeRegister":true
     }
     ```